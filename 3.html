<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Informaci√≥n de la Universidad</title>
    
    <style>
        /* ************************************* */
        /* ********** ESTILOS BASE (DARK MODE) ************ */
        /* ************************************* */

        :root {
            /* Colores UIS y Tema Oscuro */
            --color-primary-green: #38A941; 
            --color-uis-green: #38A941; 
            --color-bg-dark: #050505; /* FONDO NEGRO MUY OSCURO */
            --color-container-chat: #1F2833; 
            --color-container-login: #2b3a4a; 
            --color-text-light: #e0e0e0; 
            --color-border-dark: #3a3a3a; 
            
            /* Colores de Mensajes */
            --color-user-message-bg: #007bff; 
            --color-bot-message-bg: #2b3a4a; 
            --color-bot-text: #e0e0e0;
            --color-user-text: white;
            
            /* Colores de inputs en la pantalla de bienvenida */
            --color-welcome-input-bg: #384558; 
            --color-welcome-input-border: #4a5a6a;
            
            /* Estilo para los botones del men√∫ inferior */
            --color-menu-button-bg: #4a5a6a; 
            --color-menu-button-text: #e0e0e0;
            
            /* Colores de tu fragmento de CSS */
            --color-card-bg: #1F2833; 
            --color-border: #3a3a3a;
            --color-text: #e0e0e0;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--color-bg-dark); 
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            margin: 0;
            color: var(--color-text-light);
            transition: background-color 0.3s;
            overflow: hidden; 
        }

        /* ************************************** */
        /* CONTENEDOR CENTRAL/PRINCIPAL */
        /* ************************************** */
        #contenedorCentrador {
            position: absolute; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-bg-dark); 
            display: flex; 
            justify-content: center;
            align-items: center; 
            z-index: 10;
        }
        
        .contenedor-principal {
            background-color: var(--color-container-chat); 
            width: 100%; 
            max-width: 100%; 
            height: 100%; 
            min-height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        #cuestionario {
            padding: 40px; 
            border-radius: 18px;
            max-width: 400px; 
            width: 85%; 
            height: auto;
            text-align: center;
            /* Recuadro de inicio m√°s oscuro que antes (pero m√°s claro que el fondo del body) */
            background-color: var(--color-container-chat); 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            
            display: block; 
            text-align: center;
        }

        /* ************************************* */
        /* ********** HEADER Y CONTROLES DEL CHAT ******* */
        /* ************************************* */
        
        #contenedorMenu h2 {
            background-color: var(--color-uis-green); 
            color: white;
            padding: 15px; 
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 1.4em; 
            position: relative; 
            border-bottom: 3px solid #34a853; 
        }
        
        /* Logo de inicio de sesi√≥n */
        #logo-uis-login-container {
            display: block; 
            margin: 0 auto 25px auto; 
            width: 100%; 
            text-align: center;
        }
        
        #logo-uis-login {
            height: 120px; 
            width: auto;
            margin-bottom: 12px;
            filter: none; 
        }

        /* Logo de encabezado del chat */
        #logo-uis-header {
            height: 40px; 
            width: auto;
            margin-right: 12px;
            /* Se ve en sus colores originales (verde) */
        }

        /* Men√∫ de Acciones Superior (Wrapper) */
        #menuAccionesWrapperSuperior {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            display: flex;
            align-items: center;
            padding-right: 15px;
        }

        #btnMenuAcciones {
            background-color: transparent; 
            color: white; 
            border: none;
            padding: 5px 10px; 
            border-radius: 50%; 
            font-size: 1.5em; 
            cursor: pointer;
            line-height: 1; 
            transition: color 0.2s;
            margin-right: 0; 
        }
        #btnMenuAcciones:hover {
            color: #d1e5d6; 
        }

        /* Controles Superiores (Men√∫ desplegable) */
        #controlesSuperiores {
            display: none; 
            position: absolute;
            top: 60px; 
            right: 10px; 
            
            background-color: #2c3a4a; 
            border: 1px solid var(--color-border-dark);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            z-index: 10;
            min-width: 180px; 
            flex-direction: column;
            padding: 5px 0;
        }
        #controlesSuperiores.active {
            display: flex;
        }
        
        #controlesSuperiores .btn-accion-secundaria {
            width: 100%;
            padding: 10px 15px;
            border: none;
            text-align: left;
            border-radius: 0;
            background-color: transparent;
            font-size: 0.9em;
            color: var(--color-text-light); 
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #controlesSuperiores .btn-accion-secundaria:hover {
            background-color: #3f5166; 
        }
        #controlesSuperiores .btn-accion-secundaria.cerrar-sesion {
            color: #ff6666; 
        }


        /* ************************************* */
        /* ********** ESTILOS DEL FORMULARIO ***** */
        /* ************************************* */
        
        #cuestionario h3 {
            color: var(--color-uis-green); 
            margin-top: 15px; 
            font-size: 1.7em;
            font-weight: bold;
        }
        
        #cuestionario p {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1em;
            color: #ccc; 
            text-align: center; 
        }
        
        /* Contenedor espec√≠fico para cada campo de input/label */
        .input-group {
             display: flex;
             flex-direction: column;
             width: 85%; 
             gap: 5px; 
             align-items: flex-start; 
             margin: 0 auto 15px auto; 
             text-align: left; 
        }
        
        .input-group label {
             font-size: 0.9em;
             color: #aaa; 
             margin-bottom: -5px; 
             text-align: left; 
        }
        
        /* Estilo de los inputs (AJUSTE DE ALTURA AQU√ç) */
        #cuestionario input[type="text"], 
        #cuestionario input[type="tel"] {
            width: 100%; 
            /* Reducimos el padding vertical de 12px a 8px */
            padding: 8px 15px; 
            border: 1px solid var(--color-welcome-input-border); 
            border-radius: 4px; 
            background-color: var(--color-welcome-input-bg);
            color: var(--color-text-light);
            font-size: 1em;
            box-sizing: border-box; 
        }

        /* AJUSTE DEL CHECKBOX DE AUTORIZACI√ìN */
        #labelAutorizacion {
            display: flex;
            align-items: flex-start;
            font-size: 0.85em;
            color: #ccc;
            margin: 0 auto; 
            margin-top: 5px;
            width: 85%; 
            text-align: left;
            padding-left: 2px; 
        }
        
        #checkAutorizacion {
            margin-right: 10px;
            margin-top: 3px;
            flex-shrink: 0;
            width: 15px;
            height: 15px;
            accent-color: var(--color-uis-green); 
        }

        /* AJUSTE DEL BOT√ìN INICIAR CHAT */
        #cuestionario button {
            background-color: var(--color-primary-green);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            margin: 25px auto 0 auto; 
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
            width: 85%; 
            font-weight: bold;
            display: block; 
        }
        
        #cuestionario button:hover {
            background-color: #2b8c34;
        }
        
        #alerta-inline {
            background-color: #5c1a26;
            color: #ffcccc;
            padding: 10px;
            border-radius: 5px;
            margin: 0 auto 15px auto; 
            display: none;
            font-size: 0.9em;
            width: 85%; 
            text-align: left;
        }

        /* ************************************* */
        /* ********** HISTORIAL Y FOOTER DEL CHAT ********* */
        /* ************************************* */
        
        #historialChat {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: var(--color-container-chat); 
        }

        /* Estilos de mensaje */
        .chat-user, .chat-bot {
            max-width: 85%;
            padding: 12px 15px;
            border-radius: 18px;
            line-height: 1.5;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            color: var(--color-user-text);
        }

        .chat-user {
            align-self: flex-end;
            background-color: var(--color-user-message-bg);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-bot {
            align-self: flex-start;
            background-color: var(--color-bot-message-bg); 
            color: var(--color-bot-text);
            border: 1px solid var(--color-border-dark);
            border-bottom-left-radius: 4px;
        }
        
        /* FOOTER: Input de chat y Men√∫ de botones */
        .chat-footer {
            display: flex;
            flex-direction: column;
            background-color: var(--color-bot-message-bg); 
            border-top: 1px solid var(--color-border-dark);
            padding: 10px 0 0 0; 
        }

        .chat-input {
            padding: 0 15px 10px 15px; 
            display: flex;
        }

        #inputMensaje {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid #4a5a6a;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 1em;
            outline: none;
            background-color: #384558;
            color: var(--color-text-light);
        }

        #btnEnviar {
            background-color: var(--color-primary-green);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s;
        }
        
        #opcionesFooter {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start; 
            padding: 5px 15px 10px 15px;
            background-color: var(--color-bot-message-bg);
            gap: 8px; 
        }
        
        #opcionesFooter button {
            background-color: var(--color-menu-button-bg);
            color: var(--color-menu-button-text);
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background-color 0.3s;
            white-space: nowrap; 
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        /* ************************************* */
        /* ********** RESE√ëA FOOTER (simplificado) ************ */
        /* ************************************* */
        
        #contenedorRese√±a {
            background-color: var(--color-bot-message-bg);
            padding: 15px;
            border-top: 1px solid var(--color-border-dark);
            display: none;
            flex-direction: column;
            gap: 10px;
            position: absolute;
            bottom: 0;
            width: 100%;
            z-index: 5; 
        }
        
        #contenedorRese√±a textarea {
            width: 95%; 
            height: 60px;
            padding: 10px;
            border: 1px solid #4a5a6a;
            border-radius: 8px;
            resize: none;
            background-color: #384558;
            color: var(--color-text-light);
        }

        .acciones-rese√±a {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .acciones-rese√±a button {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        #btnCancelarRese√±a {
            background-color: #555;
            color: white;
        }

        #btnGuardarRese√±a {
            background-color: var(--color-primary-green);
            color: white;
        }
        
        /* ************************************* */
        /* ********** BOT√ìN CSV FLOTANTE (VERDE TRANSL√öCIDO) ******* */
        /* ************************************* */
        #csvFloatingButton {
            position: absolute;
            bottom: 20px;
            left: 20px;
            /* Verde de la UIS con 60% de opacidad */
            background-color: rgba(56, 169, 65, 0.6); 
            color: white;
            padding: 10px 20px;
            border-radius: 4px; 
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: background-color 0.3s, transform 0.2s;
            z-index: 11;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #csvFloatingButton:hover {
            /* Ligeramente m√°s opaco al pasar el mouse */
            background-color: rgba(56, 169, 65, 0.8); 
        }

    </style>
</head>
<body>

    <button id="csvFloatingButton" onclick="descargarCSV()">CSV</button>

    <div class="contenedor-principal" id="contenedorMenu" style="display: none;">
        
        <div class="chat-header">
            <h2>
                <img id="logo-uis-header" src="Universidad_Industrial_de_Santander_logo.svg.png" alt="Logo UIS"> 
                Asistente de Informaci√≥n de la Universidad
                
                <div id="menuAccionesWrapperSuperior">
                    <button id="btnMenuAcciones" onclick="toggleMenu()">‚ãÆ</button>
                    <div id="controlesSuperiores">
                        <button class="btn-accion-secundaria" onclick="descargarCSV()">Descargar CSV</button>
                        <button class="btn-accion-secundaria" onclick="limpiarChat(false)">Limpiar Chat</button>
                        <button class="btn-accion-secundaria cerrar-sesion" onclick="volverAlInicio()">Cerrar Sesi√≥n</button>
                    </div>
                </div>
            </h2>
        </div>

        <div id="historialChat">
            <div class="chat-bot" id="initial-greeting">
            </div>
        </div>
        
        <div class="chat-footer">

            <div class="chat-input">
                <input type="text" id="inputMensaje" placeholder="Escribe tu pregunta aqu√≠..." onkeypress="manejarEnter(event)">
                <button id="btnEnviar" onclick="enviarMensaje()">‚û§</button>
            </div>

            <div id="opcionesFooter">
                <button id="btnLimpiarChat" onclick="limpiarChat(false)">üßπ Limpiar Chat</button>
                <button onclick="procesarSeleccion('carreras_ofertadas', 'Oferta de Carreras')">üßë‚Äçüéì Oferta de Carreras</button>
                <button onclick="procesarSeleccion('contacto_principal', 'Contacto')">üìû Contacto</button>
                <button onclick="procesarSeleccion('historia_uis', 'Historia de Creaci√≥n')">üìú Historia de Creaci√≥n</button>
                <button onclick="procesarSeleccion('mision_vision', 'Misi√≥n y Visi√≥n')">üß≠ Misi√≥n y Visi√≥n</button>
                <button onclick="procesarSeleccion('ubicacion_sede', 'Ubicaci√≥n (Sede)')">üìç Ubicaci√≥n (Sede)</button>
                <button onclick="procesarSeleccion('horario_atencion', 'Horario de Atenci√≥n')">üïí Horario de Atenci√≥n</button>
                <button id="btnDejarRese√±a" onclick="mostrarRese√±aForm()">‚≠ê Dejar Rese√±a</button>
            </div>
        </div>

        <div id="contenedorRese√±a">
            <label for="rese√±aCliente">Escribe tu rese√±a (m√°x. 200 caracteres):</label>
            <textarea id="rese√±aCliente" maxlength="200" placeholder="Ej: 'El asistente fue muy √∫til con la informaci√≥n de carreras'"></textarea>
            <div class="acciones-rese√±a">
                <button id="btnCancelarRese√±a" onclick="ocultarRese√±aForm()">Cancelar</button>
                <button id="btnGuardarRese√±a" onclick="guardarRese√±a()">Guardar Rese√±a</button>
            </div>
        </div>
    </div>

    <div id="contenedorCentrador">
        <div id="cuestionario">
            
            <div id="logo-uis-login-container">
                <img id="logo-uis-login" src="Universidad_Industrial_de_Santander_logo.svg.png" alt="Logo UIS"> 
                <h3 style="color: var(--color-uis-green);">Bienvenido al Asistente UIS</h3>
            </div>
            
            <p style="font-size: 1em; margin-bottom: 10px;">Para acceder, por favor introduce tus datos:</p>
            
            <div id="alerta-inline"></div>

            <div class="input-group">
                <label for="nombreUsuario">Escribe tu nombre aqu√≠</label>
                <input type="text" id="nombreUsuario" class="input-registro" required>
            </div>
            
            <div class="input-group">
                <label for="correoUsuario">Escribe tu n√∫mero de tel√©fono (10 d√≠gitos)</label>
                <input type="tel" id="correoUsuario" class="input-registro" required>
            </div>
            
            <label for="checkAutorizacion" id="labelAutorizacion">
                <input type="checkbox" id="checkAutorizacion">
                Autorizo el tratamiento de mis datos personales de acuerdo con la pol√≠tica de privacidad de la UIS.
            </label>
            
            <button onclick="iniciarMenu()">Iniciar Chat</button>
        </div>
    </div>

    <script>
        // *************************************
        // ********** PARTE 1: ESTRUCTURAS DE DATOS ************
        // *************************************

        const infoMap = {
            historia_uis: {
                titulo: "Historia de la UIS",
                cuerpo: "La Universidad Industrial de Santander (UIS) fue fundada en 1948 en Bucaramanga. Naci√≥ con el prop√≥sito de formar ingenieros para apoyar la industrializaci√≥n del pa√≠s. Hoy en d√≠a, es reconocida como una de las instituciones p√∫blicas de educaci√≥n superior m√°s importantes de Colombia.",
            },
            carreras_ofertadas: {
                titulo: "Carreras de Pregrado y Posgrado",
                cuerpo: "La UIS ofrece una amplia gama de programas. En pregrado, destacan sus ingenier√≠as (Industrial, Civil, Sistemas), Ciencias Humanas y de la Salud. En posgrado, cuenta con especializaciones, maestr√≠as y doctorados enfocados en investigaci√≥n y desarrollo.",
            },
            contacto_principal: {
                titulo: "Contacto y Ubicaci√≥n Principal",
                cuerpo: "Puedes contactarnos en la Sede Principal ubicada en Bucaramanga, Santander. \n\nTel√©fono: +57 (607) 6344000\nCorreo: buzon@uis.edu.co\nHorario de atenci√≥n: Lunes a viernes, 8:00 a.m. a 12:00 p.m. y 2:00 p.m. a 6:00 p.m.",
            },
            mision_vision: {
                titulo: "Misi√≥n y Visi√≥n UIS",
                cuerpo: "Nuestra **Misi√≥n** es formar ciudadanos y profesionales de alta calidad, generar y transferir conocimiento, y contribuir al desarrollo sostenible del pa√≠s. Nuestra **Visi√≥n** es ser una universidad de excelencia reconocida internacionalmente por su liderazgo en ciencia y tecnolog√≠a.",
            },
            ubicacion_sede: {
                titulo: "Ubicaci√≥n de la Sede Principal",
                cuerpo: "La Sede Principal de la UIS se encuentra en la **Carrera 27, Calle 9, Ciudad Universitaria** en Bucaramanga, Santander. Es f√°cil llegar usando transporte p√∫blico o particular. ¬°Te esperamos!",
            },
            horario_atencion: {
                titulo: "Horario de Atenci√≥n General",
                cuerpo: "Las oficinas administrativas tienen un horario general de **Lunes a Viernes, de 8:00 a.m. a 12:00 p.m. y de 2:00 p.m. a 6:00 p.m.** Ten en cuenta que los horarios de laboratorios y biblioteca pueden variar.",
            },
        };

        const conversationalData = {
            intents: {
                default: [
                    "Lo siento, no entend√≠ tu pregunta. ¬øPodr√≠as reformularla o seleccionar una de las opciones del men√∫?",
                ],
                saludo: [
                    "Hola! Soy el Asistente Virtual UIS, ¬øen qu√© puedo ayudarte hoy?",
                ],
            },
            keywords: {
                saludo: ["hola", "saludos"],
                historia_uis: ["historia", "fundacion"],
                carreras_ofertadas: ["carreras", "programas"],
                contacto_principal: ["contacto", "telefono"],
                mision_vision: ["mision", "vision"],
                ubicacion_sede: ["ubicacion", "sede"],
                horario_atencion: ["horario", "atencion"]
            }
        };

        let ultimoUsuario = null; 
        const registrosUsuarios = JSON.parse(localStorage.getItem('registrosUsuarios')) || [];
        const CODIGO_SECRETO = "admin123";

        // *************************************
        // ********** L√ìGICA CORE DEL CHATBOT ************
        // *************************************
        
        function displayBotResponse(cuerpo, titulo, showOptions = true) {
            
            const historialChat = document.getElementById('historialChat');
            const cuerpoFormateado = cuerpo.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            
            const botHtml = `
                <div class="chat-bot">
                    <h4>${titulo}</h4>
                    <p>${cuerpoFormateado}</p>
                </div>
            `;
            historialChat.innerHTML += botHtml;
            historialChat.scrollTop = historialChat.scrollHeight;
        }

        function displayUserMessage(mensaje) {
             const historialChat = document.getElementById('historialChat');
             const userHtml = `<div class="chat-user">${mensaje}</div>`;
             historialChat.innerHTML += userHtml;
             historialChat.scrollTop = historialChat.scrollHeight;
        }

        function procesarMensajeTexto(mensaje) {
            const mensajeNormalizado = mensaje.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

            for (const intent in conversationalData.keywords) {
                for (const keyword of conversationalData.keywords[intent]) {
                    if (mensajeNormalizado.includes(keyword)) {
                        
                        if (infoMap[intent]) {
                            const { titulo, cuerpo } = infoMap[intent];
                            displayBotResponse(cuerpo, titulo);
                            return;
                        } else {
                            const responses = conversationalData.intents[intent];
                            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                            displayBotResponse(randomResponse, "Asistente UIS", true);
                            return;
                        }
                    }
                }
            }

            const defaultResponses = conversationalData.intents.default;
            const randomDefault = defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
            displayBotResponse(randomDefault, "Asistente UIS", true);
        }
        
        function enviarMensaje() {
            const inputMensaje = document.getElementById('inputMensaje');
            const mensaje = inputMensaje.value.trim();
            
            if (mensaje === "") return;

            displayUserMessage(mensaje);
            inputMensaje.value = '';
            
            procesarMensajeTexto(mensaje);
        }

        function procesarSeleccion(optionValue, optionText) {
            displayUserMessage(optionText);
            const { titulo, cuerpo } = infoMap[optionValue];
            displayBotResponse(cuerpo, titulo);
        }
        
        // *************************************
        // ********** L√ìGICA DE INTERFAZ Y ESTADO ************
        // *************************************
        
        function actualizarSaludoInicial(nombre) {
            
            const initialGreeting = document.getElementById('initial-greeting');

            initialGreeting.innerHTML = `
                <h4>¬°Hola, ${nombre}! Soy tu Asistente UIS</h4>
                <p>¬°Me alegra saludarte! Soy el asistente virtual de la UIS y estoy aqu√≠ para resolver tus dudas. Puedes preguntar sobre la **historia**, **carreras**, o **contacto**.</p>
            `;
        }

        function mostrarAlertaInline(mensaje) {
            const alerta = document.getElementById('alerta-inline');
            alerta.textContent = mensaje;
            alerta.style.display = 'block';
        }

        function iniciarMenu() {
            
            const nombre = document.getElementById('nombreUsuario').value.trim();
            const telefono = document.getElementById('correoUsuario').value.trim(); 
            const autorizado = document.getElementById('checkAutorizacion').checked;
            const alerta = document.getElementById('alerta-inline');
            alerta.style.display = 'none';

            if (nombre === "") {
                mostrarAlertaInline("Por favor, introduce tu nombre.");
                return;
            }

            if (telefono === "" || !/^\d{10}$/.test(telefono)) {
                mostrarAlertaInline("Por favor, introduce tu n√∫mero de tel√©fono (debe tener exactamente 10 d√≠gitos num√©ricos).");
                return;
            }

            if (!autorizado) {
                 mostrarAlertaInline("Debes autorizar el tratamiento de datos para iniciar el chat.");
                 return;
            }

            // L√≥gica de registro/b√∫squeda de usuario
            let index = registrosUsuarios.findIndex(r => r.nombre === nombre && r.telefono === telefono);
            if (index === -1) {
                const nuevoRegistro = { nombre: nombre, telefono: telefono, rese√±a: "" };
                registrosUsuarios.push(nuevoRegistro);
                localStorage.setItem('registrosUsuarios', JSON.stringify(registrosUsuarios));
                index = registrosUsuarios.length - 1;
            }
            
            ultimoUsuario = registrosUsuarios[index];

            document.getElementById('contenedorCentrador').style.display = 'none';
            document.getElementById('contenedorMenu').style.display = 'flex';
            document.getElementById('csvFloatingButton').style.display = 'none'; 

            actualizarSaludoInicial(nombre.toUpperCase());

            document.getElementById('historialChat').scrollTop = document.getElementById('historialChat').scrollHeight;
        }

        function volverAlInicio() {
            
            document.getElementById('contenedorMenu').style.display = 'none';
            document.getElementById('contenedorCentrador').style.display = 'flex';
            document.getElementById('csvFloatingButton').style.display = 'flex'; 
            limpiarChat(true); 
            ocultarRese√±aForm();
            
            document.getElementById('nombreUsuario').value = '';
            document.getElementById('correoUsuario').value = '';
            document.getElementById('checkAutorizacion').checked = false;
            document.getElementById('alerta-inline').style.display = 'none';
            document.getElementById('controlesSuperiores').classList.remove('active');
        }

        function limpiarChat(isFullReset = false) {
            
            const historialChat = document.getElementById('historialChat');

            historialChat.innerHTML = document.getElementById('initial-greeting').outerHTML;
            const alertHtml = `
                <div class="chat-bot" style="align-self: flex-start; background-color: var(--color-bot-message-bg); color: var(--color-text-light);">
                    <h4>üßπ Chat Limpio</h4>
                    <p>El historial de la conversaci√≥n actual ha sido **limpiado** con √©xito.</p>
                </div>
            `;
            if (!isFullReset) {
                 historialChat.innerHTML += alertHtml.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            }
            historialChat.scrollTop = historialChat.scrollHeight;
            document.getElementById('controlesSuperiores').classList.remove('active');
        }
        
        function mostrarRese√±aForm() {
            document.querySelector('.chat-footer').style.display = 'none';
            document.getElementById('contenedorRese√±a').style.display = 'flex';
            document.getElementById('historialChat').scrollTop = document.getElementById('historialChat').scrollHeight;
            document.getElementById('controlesSuperiores').classList.remove('active');
        }

        function ocultarRese√±aForm() {
            document.getElementById('contenedorRese√±a').style.display = 'none';
            document.querySelector('.chat-footer').style.display = 'flex'; 
            document.getElementById('rese√±aCliente').value = '';
        }

        function guardarRese√±a() {
            const rese√±a = document.getElementById('rese√±aCliente').value.trim();
            
            if (rese√±a === "") {
                alert("Tu rese√±a est√° vac√≠a. Por favor, escribe un comentario.");
                return;
            }

            if (!ultimoUsuario) {
                alert("Error: Usuario no registrado. Vuelve a iniciar sesi√≥n.");
                return;
            }
            
            let rese√±aLimpia = rese√±a.replace(/,/g, ";").replace(/\n/g, " ");
            ultimoUsuario.rese√±a = rese√±aLimpia;

            const index = registrosUsuarios.findIndex(r => r.nombre === ultimoUsuario.nombre && r.telefono === ultimoUsuario.telefono);
            
            if (index !== -1) {
                registrosUsuarios[index].rese√±a = rese√±aLimpia;
                localStorage.setItem('registrosUsuarios', JSON.stringify(registrosUsuarios));
                alert("Rese√±a enviada! Gracias por tus comentarios.");
            } else {
                 alert("Error al guardar: Registro no encontrado.");
            }

            ocultarRese√±aForm();
        }

        function descargarCSV() {
            const password = prompt("Introduce el c√≥digo secreto para descargar la lista:");
            
            if (password !== CODIGO_SECRETO) {
                 alert("C√≥digo incorrecto.");
                 return;
            }

            if (registrosUsuarios.length === 0) { alert("No hay datos para exportar."); return; }

            const encabezado = "Nombre_Usuario,Numero_Telefono,Rese√±a\n";
            let filasCSV = "";

            registrosUsuarios.forEach(registro => {
                const nombre = registro.nombre || "";
                const telefono = registro.telefono || ""; 
                const rese√±a = registro.rese√±a ? registro.rese√±a.replace(/"/g, '""') : "Sin rese√±a"; 
                
                filasCSV += `"${nombre}","${telefono}","${rese√±a}"\n`; 
            });
            
            const blob = new Blob([encabezado + filasCSV], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'datos_usuarios_y_rese√±as.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert("Exportaci√≥n exitosa!");
            
            document.getElementById('controlesSuperiores').classList.remove('active');
        }
        
        function manejarEnter(event) {
            if (event.key === 'Enter') {
                document.getElementById('btnEnviar').click();
                return false;
            }
            return true;
        }

        // ** L√≥gica para el Men√∫ Desplegable (Tus estilos) **
        function toggleMenu() {
            const menu = document.getElementById('controlesSuperiores');
            menu.classList.toggle('active');
        }

        // Cierra el men√∫ si se hace clic fuera
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('controlesSuperiores');
            const btn = document.getElementById('btnMenuAcciones');
            const wrapper = document.getElementById('menuAccionesWrapperSuperior');
            
            if (menu && menu.classList.contains('active') && wrapper && !wrapper.contains(event.target) && event.target !== btn) {
                menu.classList.remove('active');
            }
        });
        
        // Configuraci√≥n inicial al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('contenedorMenu').style.display = 'none';
             document.getElementById('contenedorCentrador').style.display = 'flex';
             document.getElementById('csvFloatingButton').style.display = 'flex'; 
        });

    </script>
</body>
</html>